## 修复《西游记-PPS》因帐号名大小写转换不一致导致充值被计入错误账户下的数据

### 背景介绍：
由于《西游记》混服联运的认证接口和充值接口对帐号名的大小写处理方式不一致（认证
接口强制全转小写，充值接口按原值记录），导致部分玩家完了（实际我们记录的是小写
的帐号名）一段时间游戏后进行充值时（此时接收到的帐号名是大写的，我们未做转换直
接记录了），金额被被记在了大写帐号的账户下。原来一直在游戏中使用的帐号（被我们
转为小写的那个）上面看不到充值的金额。

此次更新，即为修改此问题。

**修改方案：**

1 查询出有问题的充值记录的详细信息
2 从错误的账户中删除全部充值数据
  共3个表：UMS_USER_FUND、UMS_USER_FUND_DETAIL、LOG_USER_FUND_DETAIL。
3 使用第一步获取的充值信息调用PKG_BALANCE.innerCharge()为正确的账户充值
4 删除错误的帐号（大写帐号名的帐号）
5 检验修复结果

### 使用方法
    ./migrate.sh username/password@tns

### 操作内容

* 查询存在错误充值数据的账户信息
      Users with wrong charge msgs and their duplicated name.
      -------------------------------------------------------
      帐号ID     帐号名
      1533934694 chenjunj2
      1534156628 chenjunJ2
      1534003370 llh1973-com
      1534118551 LLH1973-COM
      1533561632 yi529272252
      1533661924 YI529272252
  如果此处输出为空，则表示没有帐号发生因充值导致创建重复帐号的问题。

* 查询错误充值数据的信息
      Wrong charge msg info.
      -------------------------------------------------------
      充值流水号（LK）充值错充到此帐号         需要将充值迁移到此帐号
      128291286246572 1533661924(YI529272252)  1533561632(yi529272252)
      128430163234012 1534118551(LLH1973-COM)  1534003370(llh1973-com)
      128456905792142 1534156628(chenjunJ2)    1533934694(chenjunj2)
      128470461709208 1534156628(chenjunJ2)    1533934694(chenjunj2)
  如果此处输出为空，意义同上。

* 根据上一步查询的信息对数据进行修复
      Start processing wrong charge msgs ...
      -------------------------------------------------------
      Create needed functions
      Processing data ...
      Drop functions
      
      Finished.
  先创建需要的函数，然后调用函数执行修复数据操作，修复完毕后再将先前创建的函数drop掉。

* 对处理结果进行检测
      Checking ...
      Users with wrong charge msgs and their duplicated name.
      -------------------------------------------------------
      # 此处应该没有输出了，否则就是修复失败
      Wrong charge msg info.
      -------------------------------------------------------
      # 此处应该没有输出了，否则就是修复失败
  这里的检测操作实际就是第一步和第二步的重复执行。

* 结束
      Done!

### 关于错误数据
已经将《西游记-PPS》的错误充值相关数据导出到imp_init_data.sql文件中。

执行`./migrate.sh erating/uosdev@uosdev.lk --reset`即可在修复操作开始前，先删除**开发库**中的相关数据并重新导入线上的错误数据。

**切莫在线上使用--reset**

在开发期间，可能线上已经又有了新的错误充值数据。如果在第二步的输出不是上面提示的那4行，请联系<wangxiaofeng@linekong.com>

